<!DOCTYPE html>
<html lang="en">
<head>
    <title>Hell Craft Tech's Minecraft Bot Manager</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta charset="UTF-8">
    <HTA:APPLICATION 
        ID="BotManager"
        APPLICATIONNAME="Hell Craft Tech's Minecraft Bot Manager"
        BORDER="thick"
        BORDERSTYLE="normal"
        CAPTION="yes"
        ICON="favicon.ico"
        MAXIMIZEBUTTON="yes"
        MINIMIZEBUTTON="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        SYSMENU="yes"
        WINDOWSTATE="maximized"
        INNERBORDER="yes"
        SCROLL="auto"
        NAVIGABLE="yes"
    />
    <style>
/* HTA-Compatible Professional Design */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Base Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0f172a;
    min-height: 100vh;
    color: #ffffff;
    line-height: 1.6;
    overflow-x: hidden;
}

/* Container */
.container {
    width: 100%;
    min-height: 100vh;
    background: #1e293b;
}

/* Header */
.header {
    background: linear-gradient(135deg, #e94560 0%, #533483 100%);
    padding: 2rem;
    text-align: center;
    box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
}

.header-content {
    position: relative;
}

.header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    letter-spacing: 1px;
}

.header-subtitle {
    font-size: 1.1rem;
    opacity: 0.95;
    margin-bottom: 0.3rem;
}

.header-author {
    font-size: 0.9rem;
    opacity: 0.85;
    font-style: italic;
}

/* Main Content */
.content {
    padding: 2rem;
    max-width: 100%;
    margin: 0 auto;
}

/* Card */
.card {
    background: #334155;
    border: 2px solid #475569;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.card:hover {
    border-color: #e94560;
    box-shadow: 0 10px 40px rgba(233, 69, 96, 0.3);
}

/* Section Title */
.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #e94560;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid #e94560;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* Grid Layouts */
.grid {
    display: grid;
    gap: 1.5rem;
}

.grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
}

.grid-cols-auto {
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

/* Bot Card */
.bot-card {
    background: linear-gradient(145deg, #2d3748 0%, #1e293b 100%);
    border: 2px solid #475569;
    border-radius: 10px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.bot-card:hover {
    border-color: #e94560;
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(233, 69, 96, 0.25);
}

.bot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #475569;
}

.bot-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #f472b6;
    text-transform: uppercase;
    letter-spacing: 1.5px;
}

/* Status Indicator */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    box-shadow: 0 0 10px currentColor;
}

.status-running {
    background: #10b981;
}

.status-stopped {
    background: #ef4444;
}

.status-installing {
    background: #f59e0b;
}

/* Form Elements */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    margin-bottom: 0.4rem;
    color: #cbd5e1;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #475569;
    border-radius: 8px;
    font-size: 0.95rem;
    background: #1e293b;
    color: #ffffff;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #e94560;
    background: #0f172a;
    box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
}

.form-input:hover,
.form-select:hover,
.form-textarea:hover {
    border-color: #64748b;
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
    font-family: 'Consolas', 'Courier New', monospace;
    line-height: 1.8;
}

.hidden {
    display: none !important;
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

.btn:active {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* Button Variants */
.btn-primary {
    background: linear-gradient(135deg, #e94560 0%, #a855f7 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #06b6d4 0%, #0284c7 100%);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-block {
    width: 100%;
    display: block;
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 0.95rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
}

/* Button Grid */
.btn-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-top: 1.25rem;
}

.btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* Action Groups */
.action-group {
    margin-bottom: 1.5rem;
}

.action-group:last-child {
    margin-bottom: 0;
}

.action-group-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #475569;
}

/* Bot Form Row */
.bot-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

/* Log Container */
.log-container {
    background: #0f172a;
    color: #10b981;
    padding: 1.5rem;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 2;
    border: 2px solid #475569;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
}

/* Bot Log Container */
.bot-log-container {
    background: #0f172a;
    color: #10b981;
    padding: 0.75rem;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 0.7rem;
    line-height: 1.6;
    border: 2px solid #475569;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
    margin-top: 1rem;
    display: none;
}

.bot-log-container.active {
    display: block;
}

.log-entry {
    margin-bottom: 4px;
}

.log-success { color: #10b981; }
.log-error { color: #ef4444; }
.log-warning { color: #f59e0b; }
.log-info { color: #06b6d4; }

/* Footer */
.footer {
    background: #0f172a;
    padding: 1.5rem;
    text-align: center;
    color: #94a3b8;
    font-size: 0.85rem;
    border-top: 3px solid #e94560;
    margin-top: 2rem;
}

/* Utility Classes */
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 0.75rem; }
.mb-3 { margin-bottom: 1rem; }
.mb-4 { margin-bottom: 1.5rem; }
.mb-5 { margin-bottom: 2rem; }

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 0.75rem; }
.mt-3 { margin-top: 1rem; }
.mt-4 { margin-top: 1.5rem; }
.mt-5 { margin-top: 2rem; }

/* Responsive Design */
@media (max-width: 1200px) {
    .grid-cols-auto {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .header h1 {
        font-size: 2rem;
    }
    
    .content {
        padding: 1rem;
    }
    
    .card {
        padding: 1rem;
    }
    
    .grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .config-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .bot-form-row {
        grid-template-columns: 1fr;
        gap: 0;
    }
    
    .grid-cols-auto {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>Hell Craft Tech's Minecraft Bot Manager</h1>
                <p class="header-subtitle">Professional Bot Management System for Pika & Jartex Network</p>
                <p class="header-author">Built by LEKING001</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="content">
            <!-- Global Actions -->
            <div class="card slide-up">
                <h2 class="section-title">Quick Actions</h2>
                
                <!-- Bot Control -->
                <div class="action-group">
                    <h3 class="action-group-title">Bot Control</h3>
                    <div class="btn-group">
                        <button class="btn btn-info btn-sm" onclick="startAllBots()">
                            <span>‚ñ∂Ô∏è Start All</span>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="stopAllBots()">
                            <span>‚èπÔ∏è Stop All</span>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="toggleSilentMode()" id="silentModeBtn">
                            <span>üîá Silent Mode</span>
                        </button>
                    </div>
                </div>
                
                <!-- Configuration -->
                <div class="action-group">
                    <h3 class="action-group-title">Configuration</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="saveConfig()">
                            <span>üíæ Save Config</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="loadConfig()">
                            <span>üîÑ Reload</span>
                        </button>
                    </div>
                </div>
                
                <!-- Dependencies -->
                <div class="action-group">
                    <h3 class="action-group-title">Dependencies</h3>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="installAll()">
                            <span>ÔøΩ Install All</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="uninstallAll()">
                            <span>ÔøΩÔ∏è Uninstall All</span>
                        </button>
                    </div>
                </div>
                
                <!-- System -->
                <div class="action-group">
                    <h3 class="action-group-title">System</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="configureStartup()">
                            <span>üöÄ Configure Startup</span>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="installNodeJS()">
                            <span>üì¶ Install Node.js</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Server Configuration -->
            <div class="card slide-up">
                <h2 class="section-title">Server Configuration</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label class="form-label">Server IP</label>
                        <input type="text" class="form-input" id="serverIp" value="play.pika-network.net" placeholder="Enter server IP">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server Version</label>
                        <input type="text" class="form-input" id="serverVersion" value="1.18.1" placeholder="e.g., 1.18.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Chat Messages / Commands (one per line)</label>
                    <textarea class="form-textarea" id="chatMessages" placeholder="Enter commands/messages (one per line)">/login password
/server survival
/home base</textarea>
                </div>
                <div class="config-grid">
                    <div class="form-group">
                        <label class="form-label">Repeat Messages</label>
                        <select class="form-select" id="repeatMessages">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Repeat Delay (seconds)</label>
                        <input type="number" class="form-input" id="repeatDelay" value="6" min="1" placeholder="Seconds">
                    </div>
                </div>
                <div class="mt-4">
                    <button class="btn btn-primary btn-block btn-lg" onclick="saveConfig()">
                        <span>Save Configuration</span>
                    </button>
                </div>
            </div>

            <!-- Bot Configurations -->
            <div class="card slide-up">
                <h2 class="section-title">Bot Configurations</h2>
                <div class="grid grid-cols-auto" id="botConfigs">
                    <!-- Bot cards will be dynamically generated here -->
                </div>
            </div>
            
            <!-- Activity Log -->
            <div class="card slide-up">
                <h2 class="section-title">Activity Log</h2>
                <div class="log-container" id="logContainer">
                    <!-- Logs will be displayed here -->
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            Hell Craft Tech's Minecraft Bot Manager v2.0 | Built by LEKING001 for Pika & Jartex Network
        </div>
    </div>

    <script type="text/javascript">
// Hell Craft Tech's Minecraft Bot Manager - Script
// Modern JavaScript for Bot Management with HTA compatibility

var fso = new ActiveXObject("Scripting.FileSystemObject");
var shell = new ActiveXObject("WScript.Shell");
var configPath = fso.BuildPath(shell.CurrentDirectory, "global_config.json");
var processIds = {};
var logTailIntervals = {}; // Store interval IDs for log tailing
var lastLogPositions = {}; // Store last read positions for each log file
var botPorts = { "MC1": 3001, "MC2": 3002, "MC3": 3003, "MC4": 3004 }; // Port mappings
var silentMode = false; // Silent mode flag - when true, window is hidden but bots keep running

// Cleanup on window close
window.onbeforeunload = function() {
    if (!silentMode) {
        cleanup();
    }
};

// Load configuration on startup
window.onload = function() {
    loadConfig();
    checkStartupArguments();
};

function loadConfig() {
    try {
        if (!fso.FileExists(configPath)) {
            logMessage("Configuration file not found. Creating default...", "warning");
            createDefaultConfig();
            return;
        }
        
        var file = fso.OpenTextFile(configPath, 1);
        var content = file.ReadAll();
        file.Close();
        
        var config = JSON.parse(content);
        renderServerConfig(config.server);
        renderBotConfigs(config.accounts);
        logMessage("Configuration loaded successfully", "success");
    } catch (e) {
        logMessage("Error loading configuration: " + e.message, "error");
        createDefaultConfig();
    }
}

function createDefaultConfig() {
    var defaultConfig = {
        accounts: {
            MC1: { username: "Player1", password: "", type: "offline" },
            MC2: { username: "Player2", password: "", type: "offline" },
            MC3: { username: "Player3", password: "", type: "offline" },
            MC4: { username: "Player4", password: "", type: "offline" }
        },
        server: {
            ip: "play.pika-network.net",
            version: "1.18.1",
            chatMessages: ["/login mcmc12", "/server survival", "/home home"],
            repeat: true,
            repeatDelay: 6
        }
    };
    
    try {
        var file = fso.CreateTextFile(configPath, true);
        file.Write(JSON.stringify(defaultConfig, null, 4));
        file.Close();
        
        renderServerConfig(defaultConfig.server);
        renderBotConfigs(defaultConfig.accounts);
        logMessage("Default configuration created", "success");
    } catch (e) {
        logMessage("Error creating default configuration: " + e.message, "error");
    }
}

function showAlert(message) {
    alert(message);
}

function renderServerConfig(server) {
    document.getElementById("serverIp").value = server.ip || "";
    document.getElementById("serverVersion").value = server.version || "";
    document.getElementById("chatMessages").value = server.chatMessages ? server.chatMessages.join("\n") : "";
    document.getElementById("repeatMessages").value = server.repeat ? "Yes" : "No";
    document.getElementById("repeatDelay").value = server.repeatDelay || 6;
}

function renderBotConfigs(accounts) {
    var container = document.getElementById("botConfigs");
    container.innerHTML = "";
    
    var botNames = ["MC1", "MC2", "MC3", "MC4"];
    for (var i = 0; i < botNames.length; i++) {
        var botName = botNames[i];
        var account = accounts[botName] || { username: "", password: "", type: "offline" };
        
        var card = document.createElement("div");
        card.className = "bot-card";
        card.innerHTML = '<div class="bot-header">' +
            '<h3 class="bot-name">' + botName + '</h3>' +
            '<span class="status-indicator status-stopped" id="status-' + botName + '"></span>' +
            '</div>' +
            '<div class="bot-form-row">' +
            '<div class="form-group">' +
            '<label class="form-label">USERNAME</label>' +
            '<input type="text" class="form-input" id="username-' + botName + '" value="' + (account.username || '') + '">' +
            '</div>' +
            '<div class="form-group">' +
            '<label class="form-label">ACCOUNT TYPE</label>' +
            '<select class="form-select" id="type-' + botName + '" onchange="togglePasswordField(\'' + botName + '\')">' +
            '<option value="offline"' + (account.type === "offline" ? ' selected' : '') + '>Offline</option>' +
            '<option value="mojang"' + (account.type === "mojang" ? ' selected' : '') + '>Mojang</option>' +
            '<option value="microsoft"' + (account.type === "microsoft" ? ' selected' : '') + '>Microsoft</option>' +
            '</select>' +
            '</div>' +
            '</div>' +
            '<div class="form-group' + (account.type === "offline" ? ' hidden' : '') + '" id="password-group-' + botName + '">' +
            '<label class="form-label">PASSWORD</label>' +
            '<input type="password" class="form-input" id="password-' + botName + '" value="' + (account.password || '') + '">' +
            '</div>' +
            '<div class="btn-grid">' +
            '<button class="btn btn-primary" onclick="saveBotConfig(\'' + botName + '\')">Save</button>' +
            '<button class="btn btn-success" onclick="installBot(\'' + botName + '\')">Install</button>' +
            '<button class="btn btn-info" onclick="startBot(\'' + botName + '\')">Start</button>' +
            '<button class="btn btn-warning" onclick="stopBot(\'' + botName + '\')">Stop</button>' +
            '</div>' +
            '<div class="bot-log-container" id="log-' + botName + '"></div>';
        
        container.appendChild(card);
    }
}

function togglePasswordField(botName) {
    var type = document.getElementById("type-" + botName).value;
    var passwordGroup = document.getElementById("password-group-" + botName);
    
    if (type === "offline") {
        passwordGroup.className = "form-group hidden";
    } else {
        passwordGroup.className = "form-group";
    }
}

function saveConfig() {
    try {
        logMessage("Starting configuration save...", "info");
        
        var file = fso.OpenTextFile(configPath, 1);
        var content = file.ReadAll();
        file.Close();
        var config = JSON.parse(content);
        
        config.server = {
            ip: document.getElementById("serverIp").value,
            version: document.getElementById("serverVersion").value,
            chatMessages: document.getElementById("chatMessages").value.split("\n").filter(function(msg) { return msg.trim() !== ""; }),
            repeat: document.getElementById("repeatMessages").value === "Yes",
            repeatDelay: parseInt(document.getElementById("repeatDelay").value) || 6
        };
        
        var botNames = ["MC1", "MC2", "MC3", "MC4"];
        for (var i = 0; i < botNames.length; i++) {
            var botName = botNames[i];
            var type = document.getElementById("type-" + botName).value;
            config.accounts[botName] = {
                username: document.getElementById("username-" + botName).value,
                password: type === "offline" ? "" : document.getElementById("password-" + botName).value,
                type: type
            };
        }
        
        logMessage("Writing to file: " + configPath, "info");
        var outFile = fso.CreateTextFile(configPath, true);
        outFile.Write(JSON.stringify(config, null, 4));
        outFile.Close();
        
        logMessage("Configuration saved successfully!", "success");
        showAlert("Configuration saved successfully!");
    } catch (e) {
        logMessage("Error saving configuration: " + e.message, "error");
        showAlert("Error saving configuration: " + e.message);
    }
}

function saveBotConfig(botName) {
    try {
        logMessage("Saving " + botName + " configuration...", "info");
        
        var file = fso.OpenTextFile(configPath, 1);
        var content = file.ReadAll();
        file.Close();
        var config = JSON.parse(content);
        
        var type = document.getElementById("type-" + botName).value;
        config.accounts[botName] = {
            username: document.getElementById("username-" + botName).value,
            password: type === "offline" ? "" : document.getElementById("password-" + botName).value,
            type: type
        };
        
        var outFile = fso.CreateTextFile(configPath, true);
        outFile.Write(JSON.stringify(config, null, 4));
        outFile.Close();
        
        logMessage(botName + " configuration saved successfully!", "success");
        showAlert(botName + " configuration saved successfully!");
    } catch (e) {
        logMessage("Error saving " + botName + " configuration: " + e.message, "error");
        showAlert("Error saving " + botName + " configuration: " + e.message);
    }
}

function installBot(botName) {
    try {
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        if (!fso.FolderExists(botPath)) {
            logBotMessage(botName, "Folder not found: " + botPath, "error");
            alert("Bot folder not found: " + botName);
            return;
        }
        
        logBotMessage(botName, "Installing dependencies...", "info");
        var statusIndicator = document.getElementById("status-" + botName);
        if (statusIndicator) {
            statusIndicator.className = "status-indicator status-installing";
        }
        
        var cmd = 'cmd /c "cd /d "' + botPath + '" && npm install"';
        shell.Run(cmd, 1, true);
        
        logBotMessage(botName, "Dependencies installed successfully!", "success");
        if (statusIndicator) {
            statusIndicator.className = "status-indicator status-stopped";
        }
        alert(botName + " dependencies installed successfully!");
    } catch (e) {
        logBotMessage(botName, "Error installing: " + e.message, "error");
        var statusIndicator = document.getElementById("status-" + botName);
        if (statusIndicator) {
            statusIndicator.className = "status-indicator status-stopped";
        }
        alert("Error installing " + botName + ": " + e.message);
    }
}

function startBot(botName) {
    try {
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        if (!fso.FolderExists(botPath)) {
            logBotMessage(botName, "Folder not found: " + botPath, "error");
            if (!silentMode) alert("Bot folder not found: " + botName);
            return;
        }
        
        // Check if port is free before starting
        var port = botPorts[botName];
        if (!isPortFree(port)) {
            logBotMessage(botName, "Port " + port + " is already in use! Please stop the bot using this port first.", "error");
            if (!silentMode) alert(botName + " cannot start because port " + port + " is already in use.\n\nPlease stop any bot or process using this port and try again.");
            return;
        }
        
        logBotMessage(botName, "Port " + port + " is available", "success");
        logBotMessage(botName, "Starting bot...", "info");
        
        // Create log file path
        var logFilePath = fso.BuildPath(botPath, "bot_output.log");
        
        // Clear previous log file
        if (fso.FileExists(logFilePath)) {
            fso.DeleteFile(logFilePath);
        }
        
        // Start bot in hidden window with output redirected to log file
        var cmd = 'cmd /c "cd /d "' + botPath + '" && node bot.js > bot_output.log 2>&1"';
        shell.Run(cmd, 0, false);
        
        var statusIndicator = document.getElementById("status-" + botName);
        if (statusIndicator) {
            statusIndicator.className = "status-indicator status-running";
        }
        
        logBotMessage(botName, "Started in background!", "success");
        
        // Start reading the log file after a delay
        setTimeout(function() {
            startLogTailing(botName, logFilePath);
        }, 1000);
    } catch (e) {
        logBotMessage(botName, "Error starting: " + e.message, "error");
        if (!silentMode) alert("Error starting " + botName + ": " + e.message);
    }
}

function stopBot(botName) {
    try {
        logBotMessage(botName, "Stopping bot...", "warning");
        
        // Stop log tailing for this bot
        stopLogTailing(botName);
        
        // Since bots run in background, we need to kill node.exe processes by their working directory
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        
        // Kill all node.exe processes (since they're hidden, we can't filter by window title)
        // This is a limitation - stopping one bot might affect others
        // Better approach: kill by checking current directory
        shell.Run('cmd /c wmic process where "name=\'node.exe\' and ExecutablePath like \'%' + botName + '%\'" delete', 0, true);
        
        setTimeout(function() {
            var statusIndicator = document.getElementById("status-" + botName);
            if (statusIndicator) {
                statusIndicator.className = "status-indicator status-stopped";
            }
            logBotMessage(botName, "Bot stopped!", "success");
        }, 500);
        
    } catch (e) {
        logBotMessage(botName, "Error stopping: " + e.message, "error");
    }
}

function updateBotSettings(botName) {
    try {
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        var settingsPath = fso.BuildPath(botPath, "settings.json");
        
        if (!fso.FileExists(settingsPath)) {
            logMessage("Settings file not found for " + botName, "error");
            showAlert("Settings file not found for " + botName);
            return;
        }
        
        var file = fso.OpenTextFile(configPath, 1);
        var globalContent = file.ReadAll();
        file.Close();
        var globalConfig = JSON.parse(globalContent);
        
        var settingsFile = fso.OpenTextFile(settingsPath, 1);
        var settingsContent = settingsFile.ReadAll();
        settingsFile.Close();
        var settings = JSON.parse(settingsContent);
        
        settings.server = globalConfig.server;
        
        var outFile = fso.CreateTextFile(settingsPath, true);
        outFile.Write(JSON.stringify(settings, null, 4));
        outFile.Close();
        
        logMessage(botName + " settings updated successfully!", "success");
        showAlert(botName + " settings.json updated with global server configuration!");
    } catch (e) {
        logMessage("Error updating " + botName + " settings: " + e.message, "error");
        showAlert("Error updating " + botName + " settings: " + e.message);
    }
}

function logMessage(message, type) {
    var logContainer = document.getElementById("logContainer");
    if (!logContainer) return;
    
    var entry = document.createElement("div");
    entry.className = "log-entry log-" + (type || "info");
    var timestamp = new Date().toLocaleTimeString();
    entry.textContent = "[" + timestamp + "] " + message;
    
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function logBotMessage(botName, message, type) {
    var logContainer = document.getElementById("log-" + botName);
    if (!logContainer) return;
    
    // Show the log container if hidden
    logContainer.className = "bot-log-container active";
    
    var entry = document.createElement("div");
    entry.className = "log-entry log-" + (type || "info");
    var timestamp = new Date().toLocaleTimeString();
    entry.textContent = "[" + timestamp + "] " + message;
    
    logContainer.appendChild(entry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // Also log to main log
    logMessage(botName + ": " + message, type);
}

function startLogTailing(botName, logFilePath) {
    // Stop existing tailing if any
    stopLogTailing(botName);
    
    // Initialize position tracker
    lastLogPositions[botName] = 0;
    
    // Read log file periodically
    logTailIntervals[botName] = setInterval(function() {
        try {
            if (!fso.FileExists(logFilePath)) {
                return;
            }
            
            var file = fso.OpenTextFile(logFilePath, 1, false);
            var content = "";
            
            if (!file.AtEndOfStream) {
                content = file.ReadAll();
            }
            file.Close();
            
            // Check if there's new content
            if (content.length > lastLogPositions[botName]) {
                var newContent = content.substring(lastLogPositions[botName]);
                lastLogPositions[botName] = content.length;
                
                // Split into lines and display
                var lines = newContent.split('\n');
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (line) {
                        // Determine log type based on content
                        var logType = "info";
                        if (line.toLowerCase().indexOf("error") >= 0) {
                            logType = "error";
                        } else if (line.toLowerCase().indexOf("warn") >= 0) {
                            logType = "warning";
                        } else if (line.toLowerCase().indexOf("success") >= 0 || 
                                 line.toLowerCase().indexOf("spawned") >= 0 ||
                                 line.toLowerCase().indexOf("logged in") >= 0) {
                            logType = "success";
                        }
                        
                        displayBotLog(botName, line, logType);
                    }
                }
            }
        } catch (e) {
            // Silently handle errors (file might be locked)
        }
    }, 500); // Check every 500ms
}

function stopLogTailing(botName) {
    if (logTailIntervals[botName]) {
        clearInterval(logTailIntervals[botName]);
        delete logTailIntervals[botName];
        delete lastLogPositions[botName];
    }
}

function displayBotLog(botName, message, type) {
    var className = "log-" + (type || "info");
    
    // Log to bot-specific container (without timestamp, as log might have its own)
    var logContainer = document.getElementById("log-" + botName);
    if (logContainer) {
        logContainer.className = "bot-log-container active";
        var logEntry = document.createElement("div");
        logEntry.className = className;
        logEntry.textContent = message;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        // Limit log entries to prevent memory issues (keep last 100 lines)
        while (logContainer.childNodes.length > 100) {
            logContainer.removeChild(logContainer.firstChild);
        }
    }
}

function isPortFree(port) {
    try {
        // Use netstat to check if port is in use
        var tempFile = fso.GetSpecialFolder(2) + "\\port_check_" + port + ".txt";
        var cmd = 'cmd /c netstat -ano | findstr ":'  + port + ' " > "' + tempFile + '"';
        shell.Run(cmd, 0, true);
        
        // Wait a bit for the file to be written
        var maxWait = 20;
        var waited = 0;
        while (!fso.FileExists(tempFile) && waited < maxWait) {
            WScript.Sleep(50);
            waited++;
        }
        
        if (!fso.FileExists(tempFile)) {
            return true; // Assume free if can't check
        }
        
        var file = fso.OpenTextFile(tempFile, 1);
        var content = "";
        if (!file.AtEndOfStream) {
            content = file.ReadAll();
        }
        file.Close();
        
        // Clean up temp file
        fso.DeleteFile(tempFile);
        
        // If content is empty or doesn't contain LISTENING, port is free
        var isFree = content.length === 0 || content.indexOf("LISTENING") === -1;
        return isFree;
    } catch (e) {
        // If error checking, assume port is free
        return true;
    }
}

function cleanup() {
    try {
        // Stop all log tailing
        var botNames = ["MC1", "MC2", "MC3", "MC4"];
        for (var i = 0; i < botNames.length; i++) {
            stopLogTailing(botNames[i]);
        }
        
        // Kill all node.exe processes silently
        shell.Run('cmd /c taskkill /F /IM node.exe /T', 0, false);
        
        // Close all CMD windows
        for (var i = 0; i < botNames.length; i++) {
            shell.Run('cmd /c taskkill /FI "WINDOWTITLE eq ' + botNames[i] + ' Bot*" /F', 0, false);
        }
    } catch (e) {
        // Silently handle cleanup errors
    }
}

function toggleSilentMode() {
    silentMode = !silentMode;
    var btn = document.getElementById("silentModeBtn");
    
    if (silentMode) {
        btn.innerHTML = '<span>ÔøΩÔ∏è Show Panel</span>';
        btn.className = "btn btn-success btn-sm";
        logMessage("Silent mode enabled - Window will minimize, bots continue running", "success");
        
        // Minimize window after a short delay
        setTimeout(function() {
            window.resizeTo(1, 1);
            window.moveTo(screen.width + 100, screen.height + 100); // Move off-screen
        }, 500);
    } else {
        btn.innerHTML = '<span>üîá Silent Mode</span>';
        btn.className = "btn btn-info btn-sm";
        logMessage("Silent mode disabled - Panel is visible", "info");
        
        // Restore window
        window.moveTo(100, 100);
        window.resizeTo(screen.availWidth - 200, screen.availHeight - 200);
    }
}

function toggleAlerts() {
    alertsDisabled = !alertsDisabled;
    var btn = document.getElementById("alertsBtn");
    
    if (alertsDisabled) {
        btn.innerHTML = '<span>üîî Enable Alerts</span>';
        btn.className = "btn btn-warning btn-sm";
        logMessage("Alert popups disabled", "success");
    } else {
        btn.innerHTML = '<span>üîï Disable Alerts</span>';
        btn.className = "btn btn-info btn-sm";
        logMessage("Alert popups enabled", "info");
    }
}

function configureStartup() {
    var startupFolder = shell.SpecialFolders("Startup");
    var shortcutPath = fso.BuildPath(startupFolder, "MinecraftBotManager.lnk");
    var htaPath = fso.BuildPath(shell.CurrentDirectory, "BotManager.hta");
    
    if (fso.FileExists(shortcutPath)) {
        var remove = confirm("Startup is currently ENABLED.\n\nDo you want to REMOVE from startup?\n\nClick OK to remove, Cancel to keep it.");
        if (remove) {
            try {
                fso.DeleteFile(shortcutPath);
                alert("‚úÖ Removed from startup successfully!");
                logMessage("Startup configuration removed", "success");
            } catch (e) {
                alert("‚ùå Error removing from startup: " + e.message);
                logMessage("Error removing startup: " + e.message, "error");
            }
        }
    } else {
        var silentModeChoice = confirm("Do you want to start in SILENT MODE on startup?\n\n‚úÖ OK = Silent Mode (auto-start all bots, hide window)\n‚ùå Cancel = Normal Mode (just open the manager)");
        
        try {
            var shortcut = shell.CreateShortcut(shortcutPath);
            shortcut.TargetPath = htaPath;
            shortcut.WorkingDirectory = shell.CurrentDirectory;
            shortcut.Description = "Hell Craft Tech's Minecraft Bot Manager";
            
            if (silentModeChoice) {
                shortcut.Arguments = "/silent";
            }
            
            shortcut.Save();
            
            var mode = silentModeChoice ? "SILENT MODE (auto-start, hidden window)" : "NORMAL MODE";
            alert("‚úÖ Added to startup successfully!\n\nMode: " + mode + "\n\nThe bot manager will now start automatically when Windows starts.");
            logMessage("Startup configured: " + mode, "success");
        } catch (e) {
            alert("‚ùå Error adding to startup: " + e.message);
            logMessage("Error configuring startup: " + e.message, "error");
        }
    }
}

function installNodeJS() {
    var confirmInstall = confirm("This will download and install Node.js LTS (Long Term Support) version.\n\n‚úÖ This is recommended if you don't have Node.js installed.\n\nProceed with installation?");
    
    if (!confirmInstall) {
        logMessage("Node.js installation cancelled by user", "warning");
        return;
    }
    
    logMessage("Starting Node.js installation process...", "info");
    
    try {
        // Check if Node.js is already installed
        var nodeCheckCmd = 'node --version';
        var nodeCheck = shell.Exec(nodeCheckCmd);
        
        // Wait a bit for the command to execute
        var timeout = 0;
        while (nodeCheck.Status == 0 && timeout < 30) {
            WScript.Sleep(100);
            timeout++;
        }
        
        if (nodeCheck.Status == 1) {
            var nodeVersion = nodeCheck.StdOut.ReadAll();
            if (nodeVersion) {
                var alreadyInstalled = confirm("Node.js is already installed!\n\nCurrent version: " + nodeVersion.trim() + "\n\nDo you want to download the latest LTS version anyway?");
                if (!alreadyInstalled) {
                    logMessage("Node.js installation cancelled - already installed: " + nodeVersion.trim(), "info");
                    return;
                }
            }
        }
    } catch (e) {
        logMessage("Could not check Node.js version (might not be installed): " + e.message, "warning");
    }
    
    // Download Node.js LTS installer
    logMessage("Opening Node.js download page...", "info");
    
    try {
        // Open the Node.js download page
        shell.Run("https://nodejs.org/en/download/", 1, false);
        
        alert("üì¶ Node.js Download Page Opened!\n\nPlease:\n1. Download the Windows Installer (.msi)\n2. Choose the LTS version (recommended)\n3. Run the installer\n4. Follow the installation wizard\n5. Restart this bot manager after installation\n\nRecommended: Use default settings during installation.");
        logMessage("Node.js download page opened in browser", "success");
        
        // Optionally, provide direct download link
        var directDownload = confirm("Would you like to download Node.js LTS installer directly?\n\n(This will start downloading the 64-bit Windows installer)");
        
        if (directDownload) {
            // Direct download link for Node.js LTS 64-bit Windows installer
            var downloadUrl = "https://nodejs.org/dist/v20.11.0/node-v20.11.0-x64.msi";
            logMessage("Starting direct download of Node.js installer...", "info");
            shell.Run(downloadUrl, 1, false);
            alert("‚úÖ Download started!\n\nThe Node.js installer will be downloaded to your Downloads folder.\n\nOnce downloaded:\n1. Run the .msi file\n2. Follow the installation wizard\n3. Restart this bot manager");
            logMessage("Node.js installer download initiated", "success");
        }
    } catch (e) {
        alert("‚ùå Error opening download page: " + e.message + "\n\nPlease manually visit: https://nodejs.org/");
        logMessage("Error opening Node.js download: " + e.message, "error");
    }
}

function checkStartupArguments() {
    try {
        var args = window.external.commandLineArgs;
        if (args && args.toLowerCase().indexOf("/silent") >= 0) {
            // Silent mode startup - hide window and auto-start
            silentMode = true;
            alertsDisabled = true;
            
            var btn = document.getElementById("silentModeBtn");
            if (btn) {
                btn.innerHTML = '<span>ÔøΩÔ∏è Show Panel</span>';
                btn.className = "btn btn-success btn-sm";
            }
            
            var alertBtn = document.getElementById("alertsBtn");
            if (alertBtn) {
                alertBtn.innerHTML = '<span>üîî Enable Alerts</span>';
                alertBtn.className = "btn btn-warning btn-sm";
            }
            
            logMessage("Started in silent mode - Auto-starting all bots...", "info");
            
            // Wait for config to load then start all bots and hide window
            setTimeout(function() {
                startAllBots();
                // Hide window completely
                setTimeout(function() {
                    window.resizeTo(1, 1);
                    window.moveTo(screen.width + 100, screen.height + 100);
                }, 1000);
            }, 2000);
        }
    } catch (e) {
        // No arguments or error reading them
    }
}

function installAll() {
    var botNames = ["MC1", "MC2", "MC3", "MC4"];
    var installCount = 0;
    var errorCount = 0;
    var totalBots = botNames.length;
    
    logMessage("Starting parallel installation for all bots...", "info");
    
    for (var i = 0; i < botNames.length; i++) {
        var botName = botNames[i];
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        
        if (!fso.FolderExists(botPath)) {
            logBotMessage(botName, "Folder not found: " + botPath, "error");
            errorCount++;
            totalBots--;
            continue;
        }
        
        logBotMessage(botName, "Starting installation...", "info");
        var statusIndicator = document.getElementById("status-" + botName);
        if (statusIndicator) {
            statusIndicator.className = "status-indicator status-installing";
        }
        
        // Start installation in background (don't wait)
        var cmd = 'cmd /c "cd /d "' + botPath + '" && npm install && echo INSTALL_COMPLETE_' + botName + ' > install_status.txt"';
        shell.Run(cmd, 7, false); // 7 = minimized window, false = don't wait
    }
    
    // Monitor installation completion
    logMessage("All installations started. Monitoring progress...", "info");
    
    var completedBots = {}; // Track which bots have completed
    
    var checkInterval = setInterval(function() {
        var completed = 0;
        
        for (var i = 0; i < botNames.length; i++) {
            var botName = botNames[i];
            var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
            var statusFile = fso.BuildPath(botPath, "install_status.txt");
            
            if (fso.FileExists(statusFile) && !completedBots[botName]) {
                completedBots[botName] = true;
                completed++;
                
                var statusIndicator = document.getElementById("status-" + botName);
                if (statusIndicator && statusIndicator.className.indexOf("stopped") === -1) {
                    statusIndicator.className = "status-indicator status-stopped";
                    logBotMessage(botName, "Installation completed!", "success");
                }
            } else if (completedBots[botName]) {
                completed++; // Count previously completed bots
            }
        }
        
        // Check if all completed
        if (completed >= totalBots - errorCount) {
            clearInterval(checkInterval);
            
            var successCount = completed;
            logMessage("All installations finished!", "success");
            
            // Clean up status files
            for (var i = 0; i < botNames.length; i++) {
                var botName = botNames[i];
                var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
                var statusFile = fso.BuildPath(botPath, "install_status.txt");
                
                try {
                    if (fso.FileExists(statusFile)) {
                        fso.DeleteFile(statusFile);
                    }
                } catch (e) {
                    // Ignore cleanup errors
                }
            }
            
            // Show summary popup
            if (errorCount === 0) {
                alert("‚úÖ All " + successCount + " bot(s) installed successfully!");
            } else {
                alert("‚ö†Ô∏è Installation completed!\n\nSuccessful: " + successCount + "\nFailed: " + errorCount);
            }
        }
    }, 2000); // Check every 2 seconds
}

function uninstallAll() {
    var confirmDelete = confirm("This will permanently delete all node_modules folders from MC1, MC2, MC3, and MC4.\n\nAre you sure you want to continue?");
    
    if (!confirmDelete) {
        logMessage("Uninstall cancelled by user", "warning");
        return;
    }
    
    var botNames = ["MC1", "MC2", "MC3", "MC4"];
    var deletedCount = 0;
    var notFoundCount = 0;
    var errorCount = 0;
    
    logMessage("Starting uninstall process...", "info");
    logMessage("Current directory: " + shell.CurrentDirectory, "info");
    
    for (var i = 0; i < botNames.length; i++) {
        var botName = botNames[i];
        var botPath = fso.BuildPath(shell.CurrentDirectory, botName);
        var nodeModulesPath = fso.BuildPath(botPath, "node_modules");
        
        logMessage("Checking " + botName + " at: " + botPath, "info");
        
        // Check if bot folder exists first
        if (!fso.FolderExists(botPath)) {
            logMessage(botName + " folder not found at: " + botPath, "error");
            errorCount++;
            continue;
        }
        
        logMessage(botName + " folder exists, checking for node_modules at: " + nodeModulesPath, "info");
        
        // Check if node_modules exists
        if (!fso.FolderExists(nodeModulesPath)) {
            notFoundCount++;
            logMessage(botName + " does not have node_modules folder (already clean)", "info");
            continue;
        }
        
        // Try to delete
        try {
            logMessage("Deleting node_modules from " + botName + "...", "warning");
            
            // Use different delete method - force delete with attributes reset
            var folder = fso.GetFolder(nodeModulesPath);
            folder.Delete(true);
            
            deletedCount++;
            logMessage(botName + " node_modules deleted successfully!", "success");
        } catch (e) {
            errorCount++;
            logMessage("Error deleting " + botName + " node_modules: " + e.message + " (Error code: " + e.number + ")", "error");
            
            // Try alternative delete method using shell
            try {
                logMessage("Trying alternative delete method for " + botName + "...", "warning");
                shell.Run('cmd /c rmdir /s /q "' + nodeModulesPath + '"', 0, true);
                
                // Check if it was deleted
                if (!fso.FolderExists(nodeModulesPath)) {
                    deletedCount++;
                    errorCount--; // Subtract the error we just added
                    logMessage(botName + " node_modules deleted successfully (using shell)!", "success");
                } else {
                    logMessage("Alternative method also failed for " + botName, "error");
                }
            } catch (e2) {
                logMessage("Alternative delete also failed: " + e2.message, "error");
            }
        }
    }
    
    if (errorCount === 0) {
        if (deletedCount > 0) {
            showAlert("Successfully deleted " + deletedCount + " node_modules folder(s)!\n\n" + notFoundCount + " bot(s) already clean.");
            logMessage("Uninstall completed: " + deletedCount + " deleted, " + notFoundCount + " already clean", "success");
        } else {
            showAlert("All bots are already clean - no node_modules folders found.");
            logMessage("Uninstall completed: All bots already clean", "info");
        }
    } else {
        showAlert("Uninstall completed with errors.\nDeleted: " + deletedCount + "\nAlready clean: " + notFoundCount + "\nErrors: " + errorCount);
        logMessage("Uninstall completed with " + errorCount + " errors", "warning");
    }
}

function startAllBots() {
    var botNames = ["MC1", "MC2", "MC3", "MC4"];
    for (var i = 0; i < botNames.length; i++) {
        startBot(botNames[i]);
    }
}

function stopAllBots() {
    var botNames = ["MC1", "MC2", "MC3", "MC4"];
    
    if (!confirm("This will stop ALL running bots and close all Node.js processes and CMD windows.\n\nAre you sure?")) {
        logMessage("Stop all cancelled by user", "info");
        return;
    }
    
    logMessage("Stopping all bots...", "warning");
    
    try {
        // Stop all log tailing
        for (var i = 0; i < botNames.length; i++) {
            stopLogTailing(botNames[i]);
        }
        
        // Kill all node.exe processes
        shell.Run('cmd /c taskkill /F /IM node.exe /T', 0, true);
        logMessage("All Node.js processes terminated", "success");
        
        // Close all CMD windows that have bot names in their titles
        for (var i = 0; i < botNames.length; i++) {
            shell.Run('cmd /c taskkill /FI "WINDOWTITLE eq ' + botNames[i] + ' Bot*" /F', 0, true);
        }
        logMessage("All CMD windows closed", "success");
        
        // Update all status indicators
        for (var i = 0; i < botNames.length; i++) {
            var statusIndicator = document.getElementById("status-" + botNames[i]);
            if (statusIndicator) {
                statusIndicator.className = "status-indicator status-stopped";
            }
        }
        
        showAlert("All bots stopped and windows closed successfully!");
    } catch (e) {
        logMessage("Error stopping bots: " + e.message, "error");
        showAlert("Error: " + e.message);
    }
}
    </script>
</body>
</html>
